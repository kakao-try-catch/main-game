name: Project Date Automation (Full + Branch)

on:
  # 1. 코드를 푸시할 때 (커밋 메시지 감지)
  push:
  # 2. [NEW] 브랜치를 새로 생성했을 때 감지
  create:
  # 3. 이슈 종료 감지
  issues:
    types: [closed]
  # 4. 프로젝트 카드 이동 감지
  projects_v2_item:
    types: [edited]

jobs:
  # [Job 1] 커밋 메시지(#이슈번호) 감지
  track_commit_start:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Start Date (By Commit)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetOrg = "kakao-try-catch";
            const fieldName = "Start date"; 

            const commits = context.payload.commits;
            const issueNumbers = new Set();
            const regex = /(?:^|\s|\[)#(\d+)(?:\s|$|\])/g;
            
            for (const commit of commits) {
              let match;
              while ((match = regex.exec(commit.message)) !== null) {
                issueNumbers.add(parseInt(match[1]));
              }
            }
            if (issueNumbers.size === 0) return;

            // 로직 수행 (함수로 분리하고 싶지만 workflow 파일 제약상 반복 기술)
            for (const issueNumber of issueNumbers) {
               try {
                const query = `query($org: String!, $repo: String!, $issue: Int!) { repository(owner: $org, name: $repo) { issue(number: $issue) { projectItems(first: 10) { nodes { id project { number } fieldValue(byName: "${fieldName}") { ... on ProjectV2ItemFieldDateValue { date } } } } } } }`;
                const resp = await github.graphql(query, { org: targetOrg, repo: context.repo.repo, issue: issueNumber });
                const item = resp.repository.issue.projectItems.nodes.find(i => i.project.number === targetProjectNumber);
                
                if (!item || (item.fieldValue && item.fieldValue.date)) continue; 

                const pQuery = `query($org: String!, $num: Int!) { organization(login: $org) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
                const pResp = await github.graphql(pQuery, { org: targetOrg, num: targetProjectNumber });
                const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === fieldName);
                if (!field) continue;

                await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { pid: pResp.organization.projectV2.id, iid: item.id, fid: field.id, d: dateValue });
                console.log(`✅ Commit Trigger: Set Start Date for #${issueNumber}`);
               } catch (e) { console.log(e.message); }
            }

  # [Job 2] ★ [NEW] 브랜치 생성 감지 -> Start Date 기록
  track_branch_creation:
    # create 이벤트이면서, 생성된 것이 'branch'일 때만 실행
    if: github.event_name == 'create' && github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Start Date (By Branch Create)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetOrg = "kakao-try-catch";
            const fieldName = "Start date"; 

            // 생성된 브랜치 이름 가져오기
            const branchName = context.payload.ref;
            console.log(`New branch detected: ${branchName}`);

            // 브랜치 이름에서 숫자 추출 (예: feature/12-login -> 12)
            // 구분자(/, -, _, #) 뒤에 오는 숫자를 찾거나, 숫자로 시작하는 경우를 찾음
            const regex = /(?:^|\/|-|_|#)(\d+)(?:-|_|\/|$)/;
            const match = branchName.match(regex);

            if (!match) {
              console.log("No issue number found in branch name.");
              return;
            }

            const issueNumber = parseInt(match[1]);
            console.log(`Detected Issue Number: #${issueNumber}`);

            try {
              // 1. 이슈 조회
              const query = `query($org: String!, $repo: String!, $issue: Int!) { repository(owner: $org, name: $repo) { issue(number: $issue) { projectItems(first: 10) { nodes { id project { number } fieldValue(byName: "${fieldName}") { ... on ProjectV2ItemFieldDateValue { date } } } } } } }`;
              const resp = await github.graphql(query, { org: targetOrg, repo: context.repo.repo, issue: issueNumber });
              
              if (!resp.repository.issue) {
                 console.log(`Issue #${issueNumber} not found in repository.`);
                 return;
              }

              const item = resp.repository.issue.projectItems.nodes.find(i => i.project.number === targetProjectNumber);
              
              if (!item) {
                console.log(`Issue #${issueNumber} is not in Project ${targetProjectNumber}.`);
                return;
              }
              
              if (item.fieldValue && item.fieldValue.date) {
                console.log(`Issue #${issueNumber} already has a Start date. Skipping.`);
                return;
              }

              // 2. 업데이트 수행
              const pQuery = `query($org: String!, $num: Int!) { organization(login: $org) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
              const pResp = await github.graphql(pQuery, { org: targetOrg, num: targetProjectNumber });
              const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === fieldName);

              if (field) {
                await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { pid: pResp.organization.projectV2.id, iid: item.id, fid: field.id, d: dateValue });
                console.log(`✅ Branch Created: Set Start Date for #${issueNumber}`);
              }
            } catch (e) { console.log(`Error: ${e.message}`); }

  # [Job 3] 카드 이동 감지
  track_status_change:
    if: github.event_name == 'projects_v2_item'
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Start Date (By Status Change)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetStatus = "In Progress";
            const dateFieldName = "Start date";
            const statusFieldName = "Status";
            const itemId = context.payload.projects_v2_item.node_id;
            const orgLogin = context.payload.organization.login;

            const query = `query($id: ID!) { node(id: $id) { ... on ProjectV2Item { id project { number } status: fieldValue(byName: "${statusFieldName}") { ... on ProjectV2ItemFieldSingleSelectValue { name } } startDate: fieldValue(byName: "${dateFieldName}") { ... on ProjectV2ItemFieldDateValue { date } } } } }`;
            const resp = await github.graphql(query, { id: itemId });
            const item = resp.node;
            if (item.project.number !== targetProjectNumber) return;

            if (item.status && item.status.name === targetStatus && (!item.startDate || !item.startDate.date)) {
               const pQuery = `query($login: String!, $num: Int!) { organization(login: $login) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
               const pResp = await github.graphql(pQuery, { login: orgLogin, num: targetProjectNumber });
               const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === dateFieldName);
               if (field) {
                  await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { projectId: pResp.organization.projectV2.id, itemId: itemId, fieldId: field.id, d: dateValue });
                  console.log(`✅ Status Changed: Set Start Date`);
               }
            }

  # [Job 4] 이슈 종료 감지
  track_end_date:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Closed Date
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetOrg = "kakao-try-catch";
            const fieldName = "Closed date";
            const issueNumber = context.issue.number;

            const query = `query($org: String!, $repo: String!, $issue: Int!) { repository(owner: $org, name: $repo) { issue(number: $issue) { projectItems(first: 10) { nodes { id project { number } } } } } }`;
            const resp = await github.graphql(query, { org: targetOrg, repo: context.repo.repo, issue: issueNumber });
            const item = resp.repository.issue.projectItems.nodes.find(i => i.project.number === targetProjectNumber);

            if (!item) return;

            const pQuery = `query($org: String!, $num: Int!) { organization(login: $org) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
            const pResp = await github.graphql(pQuery, { org: targetOrg, num: targetProjectNumber });
            const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === fieldName);

            await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { pid: pResp.organization.projectV2.id, iid: item.id, fid: field.id, d: dateValue });
            console.log(`✅ Closed Issue: Set Closed Date`);
