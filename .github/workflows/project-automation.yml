name: Project Date Automation (Final Fix)

on:
  # 1. 코드를 푸시할 때 (모든 브랜치)
  push:
  # 2. 브랜치를 새로 생성했을 때
  create:
  # 3. 이슈 종료 감지
  issues:
    types: [closed]

jobs:
  # [Job 1] 착수일(Start Date) 기록 - 커밋 또는 브랜치 생성 시
  track_start_date:
    # 푸시 이벤트이거나, 브랜치 생성 이벤트일 때 실행
    if: github.event_name == 'push' || (github.event_name == 'create' && github.event.ref_type == 'branch')
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Start Date
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetOrg = "kakao-try-catch";
            const fieldName = "Start date"; 
            
            const issueNumbers = new Set();

            // Case A: 브랜치 생성 이벤트 (create)
            if (context.eventName === 'create') {
              const branchName = context.payload.ref;
              console.log(`Branch created: ${branchName}`);
              // 브랜치 이름에서 숫자 추출 (예: feature/15-login -> 15)
              const regex = /(?:^|\/|-|_|#)(\d+)(?:-|_|\/|$)/;
              const match = branchName.match(regex);
              if (match) issueNumbers.add(parseInt(match[1]));
            }
            
            // Case B: 푸시 이벤트 (push)
            if (context.eventName === 'push') {
              const commits = context.payload.commits;
              const regex = /(?:^|\s|\[)#(\d+)(?:\s|$|\])/g;
              for (const commit of commits) {
                let match;
                while ((match = regex.exec(commit.message)) !== null) {
                  issueNumbers.add(parseInt(match[1]));
                }
              }
            }

            if (issueNumbers.size === 0) {
              console.log("No issue numbers detected.");
              return;
            }
            
            console.log(`Detected Issues: ${Array.from(issueNumbers).join(', ')}`);

            // 추출된 이슈들에 대해 Start Date 업데이트
            for (const issueNumber of issueNumbers) {
               try {
                // 1. 이슈가 속한 프로젝트 아이템 찾기
                const query = `query($org: String!, $repo: String!, $issue: Int!) { repository(owner: $org, name: $repo) { issue(number: $issue) { projectItems(first: 10) { nodes { id project { number } fieldValue(byName: "${fieldName}") { ... on ProjectV2ItemFieldDateValue { date } } } } } } }`;
                const resp = await github.graphql(query, { org: targetOrg, repo: context.repo.repo, issue: issueNumber });
                
                if (!resp.repository.issue) { console.log(`#${issueNumber} not found.`); continue; }
                
                const item = resp.repository.issue.projectItems.nodes.find(i => i.project.number === targetProjectNumber);
                
                // 이미 날짜가 있거나 프로젝트에 없으면 패스
                if (!item || (item.fieldValue && item.fieldValue.date)) {
                  console.log(`Skipping #${issueNumber} (Already set or not in project)`);
                  continue; 
                }

                // 2. 필드 ID 찾기
                const pQuery = `query($org: String!, $num: Int!) { organization(login: $org) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
                const pResp = await github.graphql(pQuery, { org: targetOrg, num: targetProjectNumber });
                const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === fieldName);

                if (!field) continue;

                // 3. 업데이트 (Mutation)
                await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { pid: pResp.organization.projectV2.id, iid: item.id, fid: field.id, d: dateValue });
                console.log(`✅ Set Start Date for #${issueNumber}`);
               } catch (e) { console.log(`Error on #${issueNumber}: ${e.message}`); }
            }

  # [Job 2] 종료일(Closed Date) 기록 - 이슈 닫힘 시
  track_end_date:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Get Current Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Set Closed Date
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const dateValue = "${{ steps.date.outputs.today }}";
            const targetProjectNumber = 4;
            const targetOrg = "kakao-try-catch";
            const fieldName = "Closed date";
            const issueNumber = context.issue.number;

            const query = `query($org: String!, $repo: String!, $issue: Int!) { repository(owner: $org, name: $repo) { issue(number: $issue) { projectItems(first: 10) { nodes { id project { number } } } } } }`;
            const resp = await github.graphql(query, { org: targetOrg, repo: context.repo.repo, issue: issueNumber });
            const item = resp.repository.issue.projectItems.nodes.find(i => i.project.number === targetProjectNumber);

            if (!item) return;

            const pQuery = `query($org: String!, $num: Int!) { organization(login: $org) { projectV2(number: $num) { id fields(first: 20) { nodes { ... on ProjectV2FieldCommon { id name } } } } } }`;
            const pResp = await github.graphql(pQuery, { org: targetOrg, num: targetProjectNumber });
            const field = pResp.organization.projectV2.fields.nodes.find(f => f.name === fieldName);

            await github.graphql(`mutation($pid: ID!, $iid: ID!, $fid: ID!, $d: Date!) { updateProjectV2ItemFieldValue(input: {projectId: $pid, itemId: $iid, fieldId: $fid, value: {date: $d}}) { projectV2Item { id } } }`, { pid: pResp.organization.projectV2.id, iid: item.id, fid: field.id, d: dateValue });
            console.log(`✅ Set Closed Date for #${issueNumber}`);
